# Cryptotax
The IRS considers cryptocurrencies such as Bitcoin to be property, and thus subject to capital gains taxes when bought, sold, or exchanged for other property. Cryptocurrency marketplaces generally supply a history of a user's orders, but they do not calculate gains/losses in the method required by the IRS.  
This program generates a tax record of cryptocurrency transactions from Coinbase Pro in the IRS-required format. Particularly useful for collating many transactions.  

## Setup
- Create and activate virtual environment `cryptotax-venv`.
- Install requirements: `pip install -r requirements.txt`
- This program requires Coinbase Pro API keys. See https://help.coinbase.com/en/pro/other-topics/api/how-do-i-create-an-api-key-for-coinbase-pro for how to create API keys (requires a Coinbase Pro account) and https://docs.pro.coinbase.com/ for API documentation.
- Create a `.env` file, which will save your API keys as environment variables read by the program, containing:
  > coinbase_key = "your_key"
  > coinbase_b64secret = "your_b64secret"
  > coinbase_passphrase = "your_passphrase"
- Run `exampletaxes.py` to generate a list of transactions from a provided list of fills downloaded from Coinbase Pro.

## Cryptotax notes
Aaron Price  
2020  

Coinbase links  
[Coinbase tax resource center](https://help.coinbase.com/en/coinbase/taxes-reports-and-financial-services/taxes/coinbase-tax-resource-center.html)  
[Coinbase tax guide](https://www.coinbase.com/bitcoin-taxes)  
[Coinbase 1099-K info](https://help.coinbase.com/en/pro/taxes-reports-and-financial-services/taxes/1099-k-tax-forms-faq-for-coinbase-pro-prime-merchant.html)  
  
IRS links  
[IRS virtual currency FAQ](https://www.irs.gov/individuals/international-taxpayers/frequently-asked-questions-on-virtual-currency-transactions)  
[Schedule D (Form 1040), Capital Gains and Losses](https://www.irs.gov/forms-pubs/about-schedule-d-form-1040)  
[Form 8949, Sales and other Dispositions of Capital Assets](https://www.irs.gov/forms-pubs/about-form-8949)  
[Form 8453, Attachment to an e-filed form](https://www.irs.gov/forms-pubs/about-form-8453)  
  
Other links  
https://cryptotrader.tax/blog/mailing-in-form-8949-for-e-filing-cryptocurrency-traders  
  
Summary of process:
*	Schedule D (form 1040) reports sale or exchange of capital assets in general. Totals from form 8949 go here.
*	Form 8949 reports sales and other disposition of capital assets, itemized and detailed. Each line has the date I acquired an asset, the date I sold/exchanged it, the cost basis, the proceeds, and the resultant gain. In cases when there are too many transactions to record on the form, use Exception 2 (see 8949 instructions) I may use an attachment with similar format to report itemized transactions. That’s good, because in 2019 I had about 1100 transactions. On one line in the 8949, write “see attached statement”, and total proceeds, cost basis, and gain.
*	In the attached statement, I prepared a table with date acquired, date sold, proceeds, cost basis, and gain for each individual transaction from 2019. (Transaction meaning a capital gain or loss when it is realized. Not every order in coinbase recognizes a gain or a loss, only when I dispose of a virtual currency, so selling a crypto for USD or exchanging a crypto for another crypto.)
*	Selling a crypto for USD, or exchanging a crypto for another crypto, is recognizing a capital gain or loss. The cost basis is the USD value of what I spent to acquire the asset in the first place. The proceeds are the USD value of what I obtained in the transaction. The proceeds minus the cost basis is my gain.
    *	When I buy crypto with USD, my cost basis is the total amount I spend to acquire the crypto, counting fees. This does not recognize a gain or loss, it is just acquiring assets, but it constitutes the cost basis when I dispose of the crypto later.
    *	When I exchange crypto A for crypto B, my cost is the cost of acquiring crypto A in a previous trade, either in this same fashion or with USD (above). My proceeds are the “current fair market value” of the procured crypto B. This also constitutes the basis of the crypto B just procured. This DOES recognize a gain or loss. Again, fees are accounted for--cost basis is the amount I actually lost to make the exchange, and proceeds are the amount I actually gained.
    *	When I sell a crypto for USD, my proceeds are the actual USD procured, counting fees. This DOES recognize a gain or loss. The cost basis is from a previous trade of either above type.
*	So I need a list of my Coinbase orders to make these calculations and itemize them. Coinbase Pro has a “Statements” section where you can download “accounts” statements and “fills” statements.
    *	Accounts statements shows each change to any account balance at the match level, splitting out fees. For each order on coinbase, there will be three entries in the accounts statement, credit to the balance of the acquired currency, a debit to the account of the disposed currency, and a fee debit to the account of the quote currency (USD in and USD market, BTC in any crypto market using BTC, or ETH in the few ETH-non-BTC markets).
    *	Fills statements show each trade as a line. The market, whether you were buying or selling, the size of the base currency bought or sold, the price in quote currency, the fee in quote currency, and the “total” which is the total change to the quote currency account, accounting for the fee.
    *	The trade ids can be used to correlate the two statement types. The timestamps differ slightly between the two statements. They are never different by more than about 0.2 seconds, but sometimes they do not agree on trade order. Also, the fills’ “created at” field is not necessarily before the accounts’ “time” field. I have found an instance of the fills showing me selling a currency I didn’t buy until a fraction of a second later. Naturally this screwed up the code I was running, because, by looking at the fills statement only, it appeared I was trying to sell assets I didn’t have yet, which would leave a negative balance. In the accounts statement, I looked up the trade ids, and sure enough, they were in reverse (ie, the correct) order. Whatever the cause of this discrepancy, I believe Coinbase would be taking care to validate their account balances as trades happen, otherwise you could get overdraw, trades out of order, etc, which would be death for them. For that reason, I trust the timestamps and order presented in the accounts statement over those in the fills statement. However, the more naturally useable info is in the fills statements. In the fills statement, for each line, I perform a vlookup indexed on the trade id to pull in the accounts’ timestamp. Then I sort the fills statement on that. After some code work (below) this ends up producing an account statement identical to that generated by coinbase.
*	Summary of code process. Use the sorted and correctly ordered fills csv to generate capital gains transactions.
    *	First, run through the entire fills csv to get a dictionary of price data. This is because for crypto to crypto exchanges, you need to know the fair market value of the procured currency at the time of exchange, because that is the basis of the procured currency. To know that, you need to know the price at the time you traded crypto for crypto. This info is not included in the fills or accounts statement; for instance when placing a sell in XTZ-BTC, we dispose of XTZ and acquire BTC, and the fills provides the price of XTZ in BTC, but to calculate the basis of the BTC I just procured, I need to know the price of the BTC in USD, which is not given. However, since many of my trades are triangle trades, usually an adjacent trade placed within a second or so of this one has the price info for virtually the same exact time. So I begin by running through all the fills to populate USD price logs for every currency. Then when I need a price during a crypto-crypto transaction, I search the pricelog for the closest price available within 30 seconds of the transaction. In many cases this will find the USD price of the procured crypto within a fraction of a second of the transaction. It is good that I calculate basis from the absolute closest market price I can get, since the whole deal with triangles is it may a price blip. Later, when I’m calculating basis of a transaction, if the price can’t be found in the price log, it means I did a crypto-crypto trade but didn’t do a buy or sell win the USD market of the procured currency within 30 seconds of that trade, so I don’t know the exact-exact price for that point in time. That’s ok, because I’m not executing a triangle for whatever reason, or the triangle failed. I still need to calculate basis though so I can report it, so I query historic price data through the Coinbase API. I can get minute-granularity data. I get the price for the minute containing the transaction, and use that to calculate basis. There is a 1 query per second limit on this API call, so it’s slower too.
    *	Next I run through the fill again, this time actually calculating basis as I acquire crypto and proceeds as I dispose of crypto. When I acquire a crypto, I calculate basis, and store a “holding” item that stores the size of currency, the basis, and the time procured. AS I acquire crypto in a given currency, I add to the holding list in that given currency. Entries in the holding list were acquired at different times, may have different sizes and bases. When I dispose of a crypto, I pull from the holdings in that currency, summing the bases of each holding until I reach the size I am disposing of. This is the proceeds of the transaction. I use a First In, First Out (FIFO) approach to calculating proceeds this way, meaning I pull the oldest holding I still have first, then the next oldest. For each fill, add or pull from holdings, calculate basis, proceeds, and recognize a transaction if applicable.
    *	Buys in USD markets add to my holdings.
    *	“Buys” or “sells” in crypto markets pull from my holdings in one currency (recognizing a gain or loss), and add to my holdings in the other currency. The price of the procured currency is needed here (see above). The fields (“total” and “size”) and the signs of the fields are flipped around depending on the “side” of the trade. From a property-exchange standpoint, there is no side to this transaction, it is just exchanging property for property, but of course, Coinbase reports them differently.
    *	Sells in USD markets pull from my holdings (recognizing a gain or loss).
*	Actual work flow I used in 2019
    *	Download 2019 “fills” and “accounts” statements as csv.
    *	Reorder fills using accounts timestamps as described in earlier section.
    *	Still in excel, convert account timestamps to seconds since epoch UTM. Coinbase uses UTM time. Historical price data is reported in epoch seconds UTM. Save as csv again for easy reading with python. We now have a modified fills statement.
    *	Run tax1.py. This imports the csv I just made as a dict. It reads the csv once to create price logs. Then it reads it again to calculate bases, proceeds, and recognize gain/loss transactions. This may take some seconds as there are pauses each time it needs to query the Coinbase API for historical price data.
    *	After lots of bug fixing and verification, it runs and we have a verified list of transactions. Export the transactions to a csv. The column headers are essentially those of the 8949.
    *	Copy-paste the table into word and format a bit nicer. Change column headers to match 8949. There are no codes or adjustments (columns f, g), but I included those columns anyway. Put calculate sum totals at end of table. I made a couple hand adjustments to remove a few e-notation sizes. I find-and-replaced some garbage “--” that snuck in to some description strings because I didn’t want to rerun it and paste and format it all again. That happened because some “totals” in the fills statement are negative. They should be recorded as positive in the transactions, but I prepended an extra “-“ to the string like a dummy. Instead of running it again, I just replaced all the “--"
    *	Wrote some notes at the top of the table. This table constitutes the attachment to form 8949.
